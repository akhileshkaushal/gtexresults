---
Title: "Add title here."
author: "Sarah Urbut, Gao Wang, Peter Carbonetto and Matthew Stephens"
output: workflowr::wflow_html
---

*Add text here.*

```{r knitr, message = FALSE, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, fig.width = 8,
                      fig.height = 6,fig.align = "center",
                      comment = "#")
```

*Add text here.*

```{r thresh}
thresh <- 0.05
```

## Load data and mash results

Load some GTEx summary statistics, as well as some of the results
generated from the mash analysis of the GTEx data.

```{r load-results}
out            <- readRDS("../data/MatrixEQTLSumStats.Portable.Z.rds")
maxbeta        <- out$test.b
maxz           <- out$test.z
standard.error <- out$test.s
out  <- readRDS(paste("../output/MatrixEQTLSumStats.Portable.Z.coved.K3.P3",
                      "lite.single.expanded.V1.posterior.rds",sep = "."))
pm.mash        <- out$posterior.means
pm.mash.beta   <- pm.mash*standard.error
lfsr           <- out$lfsr
lfsr[lfsr < 0] <- 0
tissue.names   <- as.character(read.table("../data/abbreviate.names.txt")[,2])
colnames(lfsr) <- tissue.names
```

Load the results generated from the mash analysis of the GTEx data
after removing the data from the brain tissues.

``{r load-without-brain-results} 
lfsr.nobrain           <- read.table("../output/nobrainlfsr.txt")[,-1]
colnames(lfsr.nobrain) <- tissue.names[-c(7:16)]
pm.mash.nobrain <-
  as.matrix(read.table("../output/nobrainposterior.means.txt")[,-1]) *
    standard.error[,-c(7:16)]
```

Load the results generated from the mash analysis of the GTEx data for
the brain tissues only.

```{r load-brain-only-results}
lfsr.brain.only           <- read.table("../output/brainonlylfsr.txt")[,-1]
colnames(lfsr.brain.only) <- tissue.names[c(7:16)]
pm.mash.brain.only <-
  as.matrix(read.table("../output/brainonlyposterior.means.txt")[,-1]) *
    standard.error[,c(7:16)]
```

Here, we show the Proportion of Sharing by Sign:

```{r generate-tablestt}
sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)
(signall=mean(het.norm(pm.mash.beta[nsig>0,])>0))

##show that results are robust in global analysis###
sigmat=(lfsr[,-c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(signall.nobrain=mean(het.norm(pm.mash.beta[nsig,-c(7:16)])>0))

sigmat=(lfsr[,c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(signall.brainonly=mean(het.norm(pm.mash.beta[nsig>0,c(7:16)])>0))

####SHow that results are robust in specific analysis

sigmat=(lfsr.nobrain<=thresh)
nsig= rowSums(sigmat)
(signnobrain=mean(het.norm(pm.mash.nobrain[nsig>0,])>0))


sigmat=(lfsr.brain.only<=thresh)
nsig= rowSums(sigmat)
(signbrainonly=mean(het.norm(pm.mash.brain.only[nsig>0,])>0))
```

Here, we show heterogeneity by magnitude:

```{r}
sigmat=(lfsr<=thresh)
nsig= rowSums(sigmat)
(magall=mean(het.norm(pm.mash.beta[nsig>0,])>0.5))

##show that results are robust###
sigmat=(lfsr[,-c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(magall.excludingbrain=mean(het.norm(pm.mash.beta[nsig>0,-c(7:16)])>0.5))

sigmat=(lfsr[,c(7:16)]<=thresh)
nsig= rowSums(sigmat)
(magall.brainonly=mean(het.norm(pm.mash.beta[nsig>0,c(7:16)])>0.5))


##show that results are robust###
sigmat=(lfsr.nobrain<=thresh)
nsig= rowSums(sigmat)
(magnobrain=mean(het.norm(pm.mash.nobrain[nsig>0,])>0.5))

sigmat=(lfsr.brain.only<=thresh)
nsig= rowSums(sigmat)
(magbrain=mean(het.norm(pm.mash.brain.only[nsig>0,])>0.5))
```